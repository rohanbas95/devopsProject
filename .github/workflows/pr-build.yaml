name: PR Build
on:
  pull_request:
    branches: [main, "fix/*", "feat/*"]

env:
  NODE_VERSION: 20

jobs:
  pr-build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ™ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”¥ Setup NodeJS
        uses: actions/setup-node@v4
        with:
          registry-url: "https://npm.pkg.github.com"
          always-auth: true
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ› ï¸ Detect Changed Folders
        id: detect-changes
        run: |
          CHANGED_FOLDERS=$(git diff --name-only HEAD~1 | grep -oE '^level[0-9]+/' | uniq)
          echo "changed_folders=$CHANGED_FOLDERS" >> $GITHUB_ENV

      - name: ğŸ—ï¸ Build Changed Folders
        if: ${{ env.changed_folders != '' }}
        run: |
          for folder in ${{ env.changed_folders }}; do
            if [ -d "$folder/frontend" ]; then
              echo "Building frontend in $folder"
              cd $folder/frontend
              npm install
              npm run build
              cd -
            fi
            if [ -d "$folder/product-service" ]; then
              echo "Building product-service in $folder"
              cd $folder/product-service
              npm install
              npm run build
              cd -
            fi
            if [ -d "$folder/user-service" ]; then
              echo "Building user-service in $folder"
              cd $folder/user-service
              npm install
              npm run build
              cd -
            fi
          done